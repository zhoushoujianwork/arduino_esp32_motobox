# SD卡功能测试指南

## 简化版SD卡功能概述

当前版本的SD卡管理器已经简化，只保留核心功能：
- 设备信息存储（JSON格式）
- GPS数据记录（GeoJSON格式）
- 基本的空间信息查询
- 完善的错误处理和用户友好的提示

## 硬件连接

### SPI模式引脚配置
- CS: GPIO16
- MOSI: GPIO17  
- MISO: GPIO18
- SCK: GPIO5

确保SD卡模块正确连接到这些引脚。

## 串口命令测试

连接串口监视器（波特率115200），可以使用以下命令测试SD卡功能：

### 基本命令
```
help                    # 显示所有可用命令
info                    # 显示详细设备信息
status                  # 显示系统状态
restart                 # 重启设备
```

### SD卡专用命令
```
sd.info                 # 显示SD卡详细信息
sd.test                 # 测试GPS数据记录功能
sd.status               # 检查SD卡状态
```

## 错误处理和提示

### 未插入SD卡时的提示
当没有插入SD卡时，系统会显示友好的错误提示：

```
❌ SD卡初始化失败
可能的原因：
  1. 未插入SD卡
  2. SD卡损坏或格式不支持
  3. 硬件连接错误
  4. SD卡格式不是FAT32
请检查SD卡并重试
```

### SD卡状态检查
使用 `sd.status` 命令可以详细检查SD卡状态：

```
=== SD卡状态检查 ===
❌ SD卡状态: 未初始化
建议操作:
  1. 检查SD卡是否正确插入
  2. 确认SD卡格式为FAT32
  3. 重启设备重新初始化
```

### GPS数据记录错误处理
当GPS数据记录失败时，会显示具体原因：

```
❌ 无法打开GPS数据文件: /data/gps/gps_123.geojson
可能的原因：
  1. SD卡空间不足
  2. SD卡已移除
  3. 文件系统错误
```

## 预期输出示例

### 正常情况下的设备信息
```
=== 设备信息 ===
设备ID: AA:BB:CC:DD:EE:FF
固件版本: 2.3.0
硬件版本: 1.0
启动次数: 5
运行时间: 120 秒

--- 连接状态 ---
WiFi状态: 已连接
BLE状态: 未连接

--- 传感器状态 ---
GPS状态: 就绪
IMU状态: 就绪

--- 电源状态 ---
电池电压: 4200 mV
电池电量: 85%
充电状态: 未充电
外部电源: 已连接

--- SD卡状态 ---
SD卡状态: 就绪
SD卡容量: 32768 MB
SD卡剩余: 32000 MB
```

### SD卡正常时的信息输出
```
=== SD卡信息 ===
设备ID: AA:BB:CC:DD:EE:FF
总容量: 32768 MB
剩余空间: 32000 MB
使用率: 2%
初始化状态: 已初始化
```

### GPS测试成功输出
```
正在测试GPS数据记录...
测试数据: 北京天安门广场坐标
📍 GPS数据已记录: 39.904200,116.407400 (卫星:8)
✅ GPS数据记录测试成功
数据已保存到: /data/gps/gps_123.geojson
```

### SD卡初始化成功时的详细信息
```
正在初始化SD卡...
使用SPI模式，引脚配置: CS=16, MOSI=17, MISO=18, SCK=5
✅ SD卡初始化成功
SD卡类型: SDHC
SD卡容量: 32768 MB
可用空间: 32000 MB
✅ 目录结构创建完成
✅ 设备信息已保存到SD卡
```

## 文件结构

SD卡初始化成功后，会自动创建以下目录结构：

```
/
├── config/
│   └── device_info.json    # 设备信息文件
└── data/
    └── gps/
        └── gps_XXXX.geojson # GPS数据文件（按日期命名）
```

## 设备信息文件格式

`/config/device_info.json` 文件内容示例：
```json
{
  "device_id": "AA:BB:CC:DD:EE:FF",
  "firmware_version": "2.3.0",
  "created_at": "123456789",
  "sd_total_mb": 32768,
  "sd_free_mb": 32000
}
```

## GPS数据文件格式

GPS数据以GeoJSON格式存储，文件示例：
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [116.407400, 39.904200, 50.00]
      },
      "properties": {
        "timestamp": "123456789",
        "speed": 25.50,
        "satellites": 8
      }
    }
  ]
}
```

## 故障排除

### SD卡初始化失败
**症状**: 启动时显示"SD卡初始化失败"
**解决方案**:
1. 检查SD卡是否正确插入
2. 确认SD卡格式为FAT32（推荐使用32GB以下的SD卡）
3. 检查硬件连接是否正确
4. 尝试使用其他SD卡测试
5. 使用 `sd.status` 命令检查详细状态

### SD卡运行中断开
**症状**: 运行过程中SD卡功能失效
**解决方案**:
1. 检查SD卡是否松动
2. 使用 `sd.status` 命令检查当前状态
3. 重启设备重新初始化

### GPS数据记录失败
**症状**: `sd.test` 命令失败
**解决方案**:
1. 确认SD卡已正确初始化
2. 检查SD卡剩余空间（使用 `sd.info` 命令）
3. 验证GPS数据是否有效
4. 检查文件系统是否正常

### 串口命令无响应
**症状**: 输入命令后无任何输出
**解决方案**:
1. 确认串口波特率设置为115200
2. 检查串口连接是否正常
3. 确认固件已正确烧录
4. 尝试输入 `help` 命令测试

## 常见错误信息及解决方案

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|---------|
| `❌ 未检测到SD卡` | SD卡未插入或接触不良 | 重新插入SD卡 |
| `⚠️ 无法获取容量信息` | SD卡已移除或损坏 | 检查SD卡状态 |
| `❌ GPS数据无效` | GPS坐标超出有效范围 | 检查GPS数据源 |
| `❌ 无法打开GPS数据文件` | SD卡空间不足或文件系统错误 | 清理空间或重新格式化 |

## 性能优化建议

1. **SD卡选择**: 推荐使用Class 10或更高速度等级的SD卡
2. **容量建议**: 8GB-32GB容量最佳，避免使用过大容量的SD卡
3. **格式化**: 使用FAT32格式，分配单元大小选择4096字节
4. **定期维护**: 定期检查SD卡健康状态，及时备份重要数据

## 注意事项

1. 当前版本为简化版，专注于核心功能的稳定性
2. GPS数据文件按日期自动分割（基于系统运行时间）
3. 设备ID基于ESP32的MAC地址生成，每个设备唯一
4. 时间戳使用系统运行时间（毫秒），实际项目中应使用RTC或NTP时间
5. 所有错误信息都会在串口输出，便于调试和故障排除
