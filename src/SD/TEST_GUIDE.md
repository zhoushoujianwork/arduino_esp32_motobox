# SD卡功能测试指南

## 简化版SD卡功能概述

当前版本的SD卡管理器已经简化，只保留核心功能：
- 设备信息存储（JSON格式）
- GPS数据记录（GeoJSON格式）
- **GPS会话管理（按启动会话创建文件）**
- 基本的空间信息查询
- 完善的错误处理和用户友好的提示

## GPS文件命名策略

### 新的文件命名格式
```
gps_DDDD_HHMMSS_bootXXX.geojson
```

**命名规则说明：**
- `DDDD` - 运行天数（基于系统运行时间）
- `HHMMSS` - 启动时的时分秒
- `bootXXX` - 启动次数（3位数字，如boot001, boot015）

**示例文件名：**
- `gps_0001_143022_boot001.geojson` - 第1天14:30:22启动的第1次会话
- `gps_0001_160145_boot002.geojson` - 第1天16:01:45启动的第2次会话
- `gps_0002_090000_boot003.geojson` - 第2天09:00:00启动的第3次会话

### 会话管理优势
1. **每次启动创建新文件** - 便于区分不同的行程
2. **休眠后重新启动会创建新会话** - 避免数据混乱
3. **包含启动信息** - 便于数据分析和故障排除
4. **文件大小可控** - 避免单个文件过大

## 硬件连接

### SPI模式引脚配置
- CS: GPIO16
- MOSI: GPIO17  
- MISO: GPIO18
- SCK: GPIO5

确保SD卡模块正确连接到这些引脚。

## 串口命令测试

连接串口监视器（波特率115200），可以使用以下命令测试SD卡功能：

### 基本命令
```
help                    # 显示所有可用命令
info                    # 显示详细设备信息
status                  # 显示系统状态
restart                 # 重启设备
```

### SD卡专用命令
```
sd.info                 # 显示SD卡详细信息
sd.test                 # 测试GPS数据记录功能
sd.status               # 检查SD卡状态
sd.session              # 显示当前GPS会话信息
sd.finish               # 结束当前GPS会话（添加GeoJSON结尾）
```

## 新增功能说明

### GPS会话管理
每次设备启动时，会自动创建一个新的GPS会话文件，包含：

1. **会话元数据**：
   - 设备ID
   - 会话开始时间
   - 启动次数
   - 固件版本

2. **GPS数据点**：
   - 坐标信息（经纬度、海拔）
   - 时间戳
   - 运行时间（毫秒）
   - 速度信息
   - 卫星数量

### 会话结束
- 设备正常关机时应调用 `sd.finish` 命令
- 自动添加GeoJSON文件结尾，确保文件格式正确
- 便于后续数据分析工具读取

## 预期输出示例

### GPS会话信息输出
```
=== GPS会话信息 ===
当前会话文件: /data/gps/gps_0001_143022_boot001.geojson
启动次数: 1
运行时间: 120 秒
设备ID: AA:BB:CC:DD:EE:FF
```

### GPS测试输出（新版）
```
正在测试GPS数据记录...
测试数据: 北京天安门广场坐标
当前会话文件: /data/gps/gps_0001_143022_boot001.geojson
📍 GPS数据已记录: 39.904200,116.407400 (卫星:8)
✅ GPS数据记录测试成功
数据已保存到当前会话文件
```

### GPS会话结束输出
```
正在结束当前GPS会话...
✅ GPS会话已正确结束
```

## 文件结构

SD卡初始化成功后，会自动创建以下目录结构：

```
/
├── config/
│   └── device_info.json           # 设备信息文件
└── data/
    └── gps/
        ├── gps_0001_143022_boot001.geojson  # 第1次启动会话
        ├── gps_0001_160145_boot002.geojson  # 第2次启动会话
        └── gps_0002_090000_boot003.geojson  # 第3次启动会话
```

## GPS会话文件格式（增强版）

新的GPS会话文件包含更丰富的元数据：

```json
{
  "type": "FeatureCollection",
  "metadata": {
    "device_id": "AA:BB:CC:DD:EE:FF",
    "session_start": "123456789",
    "boot_count": 1,
    "firmware_version": "2.3.0"
  },
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [116.407400, 39.904200, 50.00]
      },
      "properties": {
        "timestamp": "123456789",
        "runtime_ms": 120000,
        "speed_kmh": 25.50,
        "satellites": 8,
        "hdop": 0.0
      }
    }
  ]
}
```

### 新增字段说明
- `metadata` - 会话元数据
  - `device_id` - 设备唯一标识
  - `session_start` - 会话开始时间戳
  - `boot_count` - 启动次数
  - `firmware_version` - 固件版本
- `properties` - GPS点属性
  - `runtime_ms` - 系统运行时间（毫秒）
  - `speed_kmh` - 速度（公里/小时）
  - `hdop` - 水平精度因子（预留）

## 使用场景

### 1. 摩托车行程记录
```
启动 -> 创建新会话文件 -> 记录GPS轨迹 -> 关机前结束会话
```

### 2. 多次短途出行
```
第1次: gps_0001_090000_boot001.geojson
第2次: gps_0001_140000_boot002.geojson  
第3次: gps_0001_180000_boot003.geojson
```

### 3. 休眠唤醒场景
```
启动 -> 记录GPS -> 休眠 -> 唤醒 -> 创建新会话 -> 继续记录
```

## 故障排除

### GPS会话文件问题
**症状**: GPS数据记录失败或文件格式错误
**解决方案**:
1. 使用 `sd.session` 检查当前会话状态
2. 使用 `sd.finish` 正确结束会话
3. 重启设备创建新会话

### 文件命名问题
**症状**: 文件名格式不正确
**解决方案**:
1. 检查系统时间是否正常
2. 确认启动次数计数正常
3. 重新初始化SD卡

## 最佳实践

### 1. 会话管理
- 每次长途出行前重启设备，创建新会话
- 出行结束后使用 `sd.finish` 命令结束会话
- 定期检查SD卡空间，清理旧文件

### 2. 数据分析
- 使用文件名中的启动次数区分不同行程
- 通过metadata中的session_start分析行程时间
- 利用runtime_ms字段分析设备运行状态

### 3. 故障排除
- 定期使用 `sd.session` 检查会话状态
- 出现问题时使用 `sd.status` 全面检查
- 保持固件版本记录，便于数据兼容性分析

## 注意事项

1. **文件完整性**: 使用 `sd.finish` 确保GeoJSON文件格式正确
2. **会话隔离**: 每次启动都会创建新文件，避免数据混乱
3. **时间戳**: 当前使用系统运行时间，实际项目中建议使用RTC时间
4. **存储管理**: 定期清理旧会话文件，避免SD卡空间不足
5. **数据备份**: 重要行程数据建议及时备份到云端或其他存储设备
